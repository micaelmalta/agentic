name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest jsonschema pyyaml

    - name: Run pytest
      run: |
        # Run only unit and structural tests, skip E2E tests (require special setup)
        pytest tests/ -v --tb=short --ignore=tests/e2e/

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          .pytest_cache/
          pytest.xml
        retention-days: 7

  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install markdownlint-cli
      run: npm install -g markdownlint-cli

    - name: Create markdownlint config
      run: |
        cat > .markdownlint.json << 'EOF'
        {
          "default": true,
          "MD013": false,
          "MD033": false,
          "MD041": false,
          "MD034": false
        }
        EOF

    - name: Lint markdown files
      run: |
        markdownlint '**/*.md' --ignore node_modules --ignore .github || true
        echo "Markdown linting complete (warnings only)"

  validate-yaml:
    name: Validate YAML Frontmatter
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Validate YAML frontmatter
      run: |
        python << 'EOF'
        import os
        import re
        import yaml
        from pathlib import Path

        errors = []
        skill_files = list(Path('skills').rglob('SKILL.md'))

        for skill_file in skill_files:
            content = skill_file.read_text(encoding='utf-8')

            # Check for YAML frontmatter
            if not content.startswith('---\n'):
                errors.append(f"{skill_file}: Missing YAML frontmatter")
                continue

            # Extract frontmatter
            match = re.match(r'^---\n(.*?)\n---\n', content, re.DOTALL)
            if not match:
                errors.append(f"{skill_file}: Invalid YAML frontmatter format")
                continue

            try:
                frontmatter = yaml.safe_load(match.group(1))

                # Validate required fields
                if 'name' not in frontmatter:
                    errors.append(f"{skill_file}: Missing 'name' in frontmatter")
                if 'description' not in frontmatter:
                    errors.append(f"{skill_file}: Missing 'description' in frontmatter")
                if 'triggers' not in frontmatter:
                    errors.append(f"{skill_file}: Missing 'triggers' in frontmatter")

                # Validate triggers is a list
                if 'triggers' in frontmatter and not isinstance(frontmatter['triggers'], list):
                    errors.append(f"{skill_file}: 'triggers' must be a list")

            except yaml.YAMLError as e:
                errors.append(f"{skill_file}: Invalid YAML - {e}")

        if errors:
            print("YAML validation errors found:")
            for error in errors:
                print(f"  ❌ {error}")
            exit(1)
        else:
            print(f"✅ All {len(skill_files)} SKILL.md files have valid YAML frontmatter")
        EOF

  check-cross-references:
    name: Check Cross-References
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Check for broken cross-references
      run: |
        python << 'EOF'
        import re
        from pathlib import Path

        errors = []
        warnings = []

        # Find all markdown files
        md_files = list(Path('.').rglob('*.md'))

        # Build set of all valid file paths (relative to repo root)
        valid_paths = set()
        for md_file in md_files:
            valid_paths.add(str(md_file))
            valid_paths.add(str(md_file.relative_to('.')))

        # Check each markdown file for broken references
        for md_file in md_files:
            if 'node_modules' in str(md_file) or '.git' in str(md_file):
                continue

            content = md_file.read_text(encoding='utf-8')

            # Find all markdown links: [text](path)
            links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)

            for link_text, link_path in links:
                # Skip external links (http://, https://, mailto:)
                if link_path.startswith(('http://', 'https://', 'mailto:', '#')):
                    continue

                # Remove anchor (#section) from path
                clean_path = link_path.split('#')[0]
                if not clean_path:
                    continue

                # Resolve relative path from current file's directory
                target_path = (md_file.parent / clean_path).resolve()

                # Check if target exists
                if not target_path.exists():
                    # Try relative to repo root
                    alt_path = Path(clean_path)
                    if not alt_path.exists():
                        errors.append(
                            f"{md_file}:{content[:content.find(link_path)].count(chr(10)) + 1} "
                            f"Broken link: [{link_text}]({link_path})"
                        )

        if errors:
            print("❌ Broken cross-references found:")
            for error in errors:
                print(f"  {error}")
            print(f"\nTotal: {len(errors)} broken link(s)")
            exit(1)
        else:
            print(f"✅ All cross-references valid (checked {len(md_files)} markdown files)")
        EOF

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for trailing whitespace
      run: |
        if grep -r --include="*.md" --include="*.py" --include="*.yml" --include="*.yaml" ' $' . | grep -v ".git" | grep -v "node_modules"; then
          echo "⚠️  Found trailing whitespace in files above (informational only)"
        else
          echo "✅ No trailing whitespace found"
        fi

    - name: Check files end with newline
      run: |
        files_without_newline=()
        while IFS= read -r -d '' file; do
          if [ -s "$file" ] && [ "$(tail -c 1 "$file" | wc -l)" -eq 0 ]; then
            files_without_newline+=("$file")
          fi
        done < <(find . -type f \( -name "*.md" -o -name "*.py" -o -name "*.yml" -o -name "*.yaml" \) -not -path "*/node_modules/*" -not -path "*/.git/*" -print0)

        if [ ${#files_without_newline[@]} -gt 0 ]; then
          echo "⚠️  Files not ending with newline (informational only):"
          printf '%s\n' "${files_without_newline[@]}"
        else
          echo "✅ All files end with newline"
        fi

    - name: Check for TODO/FIXME comments
      run: |
        todos=$(grep -r --include="*.md" --include="*.py" "TODO\|FIXME" . | grep -v ".github/workflows" | grep -v "node_modules" || true)
        if [ -n "$todos" ]; then
          echo "⚠️  Found TODO/FIXME comments (informational only):"
          echo "$todos"
        else
          echo "✅ No TODO/FIXME comments found"
        fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, markdown-lint, validate-yaml, check-cross-references, quality-checks]
    if: always()

    steps:
    - name: Check job results
      run: |
        echo "CI Pipeline Results:"
        echo "===================="
        echo "Tests: ${{ needs.test.result }}"
        echo "Markdown Lint: ${{ needs.markdown-lint.result }}"
        echo "YAML Validation: ${{ needs.validate-yaml.result }}"
        echo "Cross-References: ${{ needs.check-cross-references.result }}"
        echo "Quality Checks: ${{ needs.quality-checks.result }}"
        echo ""

        if [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.validate-yaml.result }}" != "success" ] || \
           [ "${{ needs.check-cross-references.result }}" != "success" ] || \
           [ "${{ needs.quality-checks.result }}" != "success" ]; then
          echo "❌ CI Pipeline Failed"
          exit 1
        else
          echo "✅ CI Pipeline Passed"
        fi
